<!doctype html><title>Chat and fight</title>
<script src="../../vendor/tquery/build/tquery-bundle-require.js"></script>
<script src="../../vendor/webaudio-bundle.js"></script>
<script>(function(){ 
// Load simplemmoserver - depends on localhost or inet hosting
	var onLocalhost	= ['localhost', '127.0.0.1'].indexOf(location.hostname) !== -1;
	var serverUrl	= onLocalhost ? 'http://localhost:8000' : 'http://simplemmoserver.jit.su:80';
	document.write("\x3cscript src='"+serverUrl+"/socket.io/socket.io.js'>\x3c/script>")
	document.write("\x3cscript src='"+serverUrl+"/src/client.js'>\x3c/script>")
})();</script>
<body><script>
requirejs.config({
	paths	: {
		"build"		: "../../vendor/tquery/build",
		"plugins"	: "../../vendor/tquery/plugins",
		'threex'	: '../../vendor/threex',
		'three.js'	: '../../vendor/three.js',
	},
});
var yeller	= {};
require([
	  'tquery.pproc'
	  
	, 'scene-light'
	, 'scene-ground'
	, 'character'
	, 'player'
	], function(){
	var world	= tQuery.createWorld().start().boilerplate({
		fullscreen	: false,
		screenshot	: false
	});

	// setup yeller
	tQuery.MicroeventMixin(yeller);


	// enable shaddow in the renderer
	world.tRenderer().shadowMapEnabled	= true;

	// determine room
	window.location.hash	= window.location.hash	|| 'Public';
	var roomName	= window.location.hash.slice(1);
	var worldName	= 'montain';


	var sceneGround	= new SceneGround({
		roomName	: roomName
	});

	//////////////////////////////////////////////////////////////////////////
	//		lights							//
	//////////////////////////////////////////////////////////////////////////
	var sceneLights	= new SceneLights()
	
	//////////////////////////////////////////////////////////////////////////
	//		player							//
	//////////////////////////////////////////////////////////////////////////
	// create player
	var player	= null;
	var characters	= {};

	//////////////////////////////////////////////////////////////////////////
	//		player							//
	//////////////////////////////////////////////////////////////////////////
	// initiate connect with server
	var onLocalhost	= ['localhost', '127.0.0.1'].indexOf(location.hostname) !== -1;
	var serverUrl	= onLocalhost ? 'http://localhost:8000/' : 'http://simplemmoserver.jit.su:80';
	var userInfo	= {
		nickName	: 'Player-'+Math.floor(Math.random()*10000).toString(16),
		skinBasename	: 'char.png',
	};
	var gameServer	= new SimpleMMOServer(worldName+'/'+roomName, userInfo, serverUrl);

	gameServer.addEventListener('roomJoined', function(sourceId, usersInfo){
		console.log('roomJoined', sourceId, usersInfo, gameServer.usersInfo())
		// create the player
		player	= new Player({
			sourceId: sourceId,
			userInfo: gameServer.userInfo()
		});
		characters[sourceId]	= player;
		// create all the others characters present in the room
		// TODO fix issue with initial cootrdinate
		Object.keys(usersInfo).forEach(function(sourceId){
			if( sourceId === player.sourceId() )	return;
			var userInfo	= usersInfo[sourceId];
			// create the character
			var character	= new Character({
				sourceId	: sourceId,
				userInfo	: userInfo
			});
			// add the character to other characters
			console.assert(characters[sourceId] === undefined)
			characters[sourceId]	= character;
		});
	});
	
	gameServer.addEventListener('userJoin', function(data){
		console.log('userJoin', arguments)
		// create the character
		var sourceId	= data.sourceId;
		var userInfo	= data.userInfo;
		var character	= new Character({
			sourceId	: sourceId,
			userInfo	: userInfo
		});
		// add the character to other characters
		console.assert(characters[sourceId] === undefined)
		characters[sourceId]	= character;
	});

	gameServer.addEventListener('userLeft', function(data){
		console.log('userLeft', data)
		
		var sourceId	= data.sourceId;
		var character	= characters[sourceId];
		// stop this player
		character.destroy();
		// remove it from the list
		delete characters[sourceId];		
	});

})
</script></body>
